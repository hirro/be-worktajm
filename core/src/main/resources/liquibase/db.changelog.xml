<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <preConditions>
        <runningAs username="tps"/>
    </preConditions>

    <!-- Add all the initial tables without foreign keys -->
    <changeSet id="1" author="hirro">
       
        <createTable tableName="tps_person">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="email" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" type="char(255)"/>
            <column name="last_name" type="char(255)"/>
            <column name="password" type="char(255)"/>
            <column name="email_verified" type="int" defaultValueBoolean="false"/>
        </createTable>
        <createIndex catalogName="tps"
                indexName="idx_email"
                schemaName="tps"
                tableName="tps_person"
                tablespace="space A"
                unique="true">
            <column name="email" type="varchar(255)"/>
        </createIndex>

        <createTable tableName="tps_project">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="char(255)"/>
            <column name="description" type="char(255)"/>
            <column name="rate" type="decimal(19,2)"/>
        </createTable>

        <createTable tableName="tps_customer">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="line1" type="char(255)"/>
            <column name="line2" type="char(255)"/>
            <column name="state" type="char(255)"/>
            <column name="zip" type="char(255)"/>
            <column name="city" type="char(255)"/>
            <column name="country" type="char(255)"/>
            <column name="reference_person" type="char(255)"/>
        </createTable>

        <createTable tableName="tps_time_entry">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="comment" type="char(255)"/>
            <column name="end_time" type="datetime"/>
            <column name="start_time" type="datetime"/>
        </createTable>
    </changeSet>

    <!-- One project has one person -->
    <changeSet id="2" author="hirro">

        <addColumn tableName="tps_project">
            <column name="person_id" type="bigint"/>
            <column name="customer_id" type="bigint"/>
        </addColumn>
        <createIndex catalogName="tps"
                indexName="idx_project_person"
                schemaName="tps"
                tableName="tps_project"
                tablespace="space A"
                unique="true">
            <column name="name" type="varchar(255)"/>
            <column name="person_id" type="bigint"/>
        </createIndex>
        <addForeignKeyConstraint 
            baseColumnNames="person_id"
            baseTableName="tps_project"
            baseTableSchemaName="tps"
            constraintName="fk_project_person"
            referencedColumnNames="id"
            referencedTableName="tps_person"
            referencedTableSchemaName="tps"/>        

    </changeSet>

    <!-- One customer has one person -->    
    <changeSet id="3" author="hirro">
        <addColumn tableName="tps_customer">
            <column name="person_id" type="bigint"/>
        </addColumn>
        <createIndex catalogName="tps"
                indexName="idx_customer_person"
                schemaName="tps"
                tableName="tps_customer"
                tablespace="space A"
                unique="true">
            <column name="name" type="varchar(255)"/>
            <column name="person_id" type="bigint"/>
        </createIndex>
        <addForeignKeyConstraint 
            baseColumnNames="person_id"
            baseTableName="tps_customer"
            baseTableSchemaName="tps"
            constraintName="fk_customer_person"
            referencedColumnNames="id"
            referencedTableName="tps_person"
            referencedTableSchemaName="tps"/>    
    </changeSet>

    <!-- One time entry has one person and one project -->
    <changeSet id="4" author="hirro">
        <addColumn tableName="tps_time_entry">
            <column name="person_id" type="bigint"/>
            <column name="project_id" type="bigint"/>
        </addColumn>        
        <addForeignKeyConstraint 
            baseColumnNames="person_id"
            baseTableName="tps_time_entry"
            baseTableSchemaName="tps"
            constraintName="fk_time_entry_person"
            referencedColumnNames="id"
            referencedTableName="tps_person"
            referencedTableSchemaName="tps"/>        
        <addForeignKeyConstraint 
            baseColumnNames="project_id"
            baseTableName="tps_time_entry"
            baseTableSchemaName="tps"
            constraintName="fk_time_entry_project"
            referencedColumnNames="id"
            referencedTableName="tps_project"
            referencedTableSchemaName="tps"/>   
    </changeSet>
    
    <!-- One person has one active project (TODO : unnecessary imho) -->
    <changeSet id="5" author="hirro">
        <addColumn tableName="tps_person">
            <column name="active_time_entry_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint 
            baseColumnNames="active_time_entry_id"
            baseTableName="tps_person"
            baseTableSchemaName="tps"
            constraintName="fk_person_time_entry"
            referencedColumnNames="id"
            referencedTableName="tps_time_entry"
            referencedTableSchemaName="tps"/>    
    </changeSet>

    <!-- One time entry has one person and one project -->
    <changeSet id="6" author="hirro">
        <addColumn tableName="tps_customer">
            <column name="invoice_period" type="char(10)"/>
        </addColumn>
    </changeSet>          
    
   <changeSet id="7" author="hirro">
      <insert tableName="tps_person" schemaName="tps">
          <column name="email" value="jim@arnellconsulting.com"/>
          <column name="first_name" value="jim"/>
          <column name="last_name" value="Arnell"/>
          <column name="password" value="password"/>
          <column name="email_verified" value="1"/>
      </insert>
   </changeSet>

</databaseChangeLog>
