<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

   <property name="now" value="sysdate" dbms="oracle"/>
   <property name="now" value="CURRENT_TIMESTAMP" dbms="mysql"/>
   
   <preConditions>
      <runningAs username="tps"/>
   </preConditions>

   <!-- Add all the plain tables without foreign keys -->
   <changeSet id="1" author="hirro">
             
      <createTable tableName="tps_person">
         <column name="id" type="bigint" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
         </column>
         <column name="created" type="timestamp" defaultValueDate="${now}">
            <constraints nullable="false" />
         </column>         
         <column name="modified" type="timestamp"/>
         <column name="email" type="varchar(255)">
            <constraints nullable="false"/>
         </column>
         <column name="first_name" type="varchar(255)"/>
         <column name="last_name" type="varchar(255)"/>
         <column name="password" type="varchar(255)"/>
         <column name="email_verified" type="bit" defaultValueBoolean="false"/>
      </createTable>
     
      <createIndex catalogName="tps"
                   indexName="idx_email"
                   schemaName="tps"
                   tableName="tps_person"
                   tablespace="space A"
                   unique="true">
         <column name="email" type="varchar(255)"/>
      </createIndex>

      <createTable tableName="tps_project">
         <column name="id" type="bigint" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
         </column>
         <column name="created" type="timestamp" defaultValueDate="${now}">
            <constraints nullable="false" />
         </column>         
         <column name="modified" type="timestamp"/>
         <column name="name" type="varchar(255)"/>
         <column name="description" type="varchar(255)"/>
         <column name="rate" type="decimal(19,2)"/>
      </createTable>

      <createTable tableName="tps_customer">
         <column name="id" type="bigint" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
         </column>
         <column name="created" type="timestamp" defaultValueDate="${now}">
            <constraints nullable="false" />
         </column>         
         <column name="modified" type="timestamp"/>
         <column name="name" type="varchar(255)">
            <constraints nullable="false"/>
         </column>
         <column name="line1" type="varchar(255)"/>
         <column name="line2" type="varchar(255)"/>
         <column name="state" type="varchar(255)"/>
         <column name="zip" type="varchar(255)"/>
         <column name="city" type="varchar(255)"/>
         <column name="country" type="varchar(255)"/>
         <column name="reference_person" type="varchar(255)"/>
      </createTable>

      <createTable tableName="tps_time_entry">
         <column name="id" type="bigint" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
         </column>
         <column name="created" type="timestamp" defaultValueDate="${now}">
            <constraints nullable="false" />
         </column>         
         <column name="modified" type="timestamp"/>
         <column name="comment" type="varchar(255)"/>
         <column name="end_time" type="datetime"/>
         <column name="start_time" type="datetime"/>
      </createTable>
   </changeSet>

   <!-- 
      Person (1) -> (*) Project, Cascade onDelete
   -->
   <changeSet id="2" author="hirro">

      <addColumn tableName="tps_project">
         <column name="person_id" type="bigint"/>
         <column name="customer_id" type="bigint"/>
      </addColumn>
      <createIndex catalogName="tps"
                   indexName="idx_project_person"
                   schemaName="tps"
                   tableName="tps_project"
                   tablespace="space A"
                   unique="true">
         <column name="name" type="varchar(255)"/>
         <column name="person_id" type="bigint"/>
      </createIndex>
      <addForeignKeyConstraint 
         baseColumnNames="person_id"
         baseTableName="tps_project"
         baseTableSchemaName="tps"
         constraintName="fk_project_person"
         referencedColumnNames="id"
         referencedTableName="tps_person"
         onDelete="CASCADE"
         referencedTableSchemaName="tps"/>
   </changeSet>

   <!-- 
      Person (1) -> (*) Customer, Cascade onDelete
      Deleting the person will delete the customer (for now since sharing isn't supported)
   -->
   <changeSet id="3" author="hirro">
      <addColumn tableName="tps_customer">
         <column name="person_id" type="bigint"/>
      </addColumn>
      <createIndex catalogName="tps"
                   indexName="idx_customer_person"
                   schemaName="tps"
                   tableName="tps_customer"
                   tablespace="space A"
                   unique="true">
         <column name="name" type="varchar(255)"/>
         <column name="person_id" type="bigint"/>
      </createIndex>
      <addForeignKeyConstraint 
         baseColumnNames="person_id"
         baseTableName="tps_customer"
         baseTableSchemaName="tps"
         constraintName="fk_customer_person"
         referencedColumnNames="id"
         referencedTableName="tps_person"
         onDelete="CASCADE"         
         referencedTableSchemaName="tps"/>    
   </changeSet>

   <!-- 
      Person (1) -> (*) TimeEntry, Cascade onDelete
   -->
   <changeSet id="4" author="hirro">
      <addColumn tableName="tps_time_entry">
         <column name="person_id" type="bigint"/>
         <column name="project_id" type="bigint"/>
      </addColumn>        
      <addForeignKeyConstraint 
         baseColumnNames="person_id"
         baseTableName="tps_time_entry"
         baseTableSchemaName="tps"
         constraintName="fk_time_entry_person"
         referencedColumnNames="id"
         referencedTableName="tps_person"
         onDelete="CASCADE"
         referencedTableSchemaName="tps"/>        
      <addForeignKeyConstraint 
         baseColumnNames="project_id"
         baseTableName="tps_time_entry"
         baseTableSchemaName="tps"
         constraintName="fk_time_entry_project"
         referencedColumnNames="id"
         referencedTableName="tps_project"
         onDelete="CASCADE"
         referencedTableSchemaName="tps"/>   
   </changeSet>
    
   <!--
      One person has one active project, Cascade onDelte
   -->
   <changeSet id="5" author="hirro">
      <addColumn tableName="tps_person">
         <column name="active_time_entry_id" type="bigint"/>
      </addColumn>      
      <addForeignKeyConstraint 
         baseColumnNames="active_time_entry_id"
         baseTableName="tps_person"
         baseTableSchemaName="tps"
         constraintName="fk_person_time_entry"
         referencedColumnNames="id"
         referencedTableName="tps_time_entry"
         onDelete="CASCADE"
         referencedTableSchemaName="tps"/>    
   </changeSet>

   <!-- Customer property invoice period which defines when invoices should be auto generated. -->
   <changeSet id="6" author="hirro">
      <addColumn tableName="tps_customer">
         <column name="invoice_period" type="varchar(10)"/>
      </addColumn>
   </changeSet>          
   
   <!-- This is a default user -->
   <changeSet id="7" author="hirro">
      <insert tableName="tps_person" schemaName="tps">
         <column name="email" value="demo@worktajm.com"/>
         <column name="first_name" value="John"/>
         <column name="last_name" value="Doe"/>
         <column name="password" value="e7da2fb90ff96aa4bc535e719444762541cded1bc37b7156c9a8cdc6abf6067e2162e859538e8f07"/>
         <column name="email_verified" valueBoolean="true"/>
      </insert>
   </changeSet>

   <!-- Customer A, two sub projects -->
   <changeSet id="8" author="hirro">
      <insert tableName="tps_customer" schemaName="tps">
         <column name="name" value="Customer A"/>
         <column name="line1" value="A street"/>
         <column name="line2" value="A box"/>
         <column name="city" value="A city"/>
         <column name="person_id" valueComputed="(SELECT id FROM tps_person WHERE email = 'demo@worktajm.com')"/>
      </insert>
      <insert tableName="tps_project" schemaName="tps">
         <column name="name" value="Project A.1"/>
         <column name="description" value="Description for project A"/>
         <column name="rate" value="666"/>
         <column name="person_id" valueComputed="(SELECT id FROM tps_person WHERE email = 'demo@worktajm.com')"/>
         <column name="customer_id" valueComputed="(SELECT id FROM tps_customer WHERE name = 'Customer A')"/>
      </insert>
      <insert tableName="tps_project" schemaName="tps">
         <column name="name" value="Project A.2"/>
         <column name="description" value="Description for project A.2"/>
         <column name="rate" value="666"/>
         <column name="person_id" valueComputed="(SELECT id FROM tps_person WHERE email = 'demo@worktajm.com')"/>
         <column name="customer_id" valueComputed="(SELECT id FROM tps_customer WHERE name = 'Customer A')"/>
      </insert>
   </changeSet>

   <!-- Customer B, two sub projects -->
   <changeSet id="9" author="hirro">
      <insert tableName="tps_customer" schemaName="tps">
         <column name="name" value="Customer B"/>
         <column name="line1" value="B street"/>
         <column name="line2" value="B box"/>
         <column name="city" value="B city"/>
         <column name="person_id" valueComputed="(SELECT id FROM tps_person WHERE email = 'demo@worktajm.com')"/>
      </insert>
      <insert tableName="tps_project" schemaName="tps">
         <column name="name" value="Project B.1"/>
         <column name="description" value="Description for project B.1"/>
         <column name="rate" value="666"/>
         <column name="person_id" valueComputed="(SELECT id FROM tps_person WHERE email = 'demo@worktajm.com')"/>
         <column name="customer_id" valueComputed="(SELECT id FROM tps_customer WHERE name = 'Customer B')"/>
      </insert>
   </changeSet>

   <!-- Project C has no customer -->
   <changeSet id="10" author="hirro">
      <insert tableName="tps_project" schemaName="tps">
         <column name="name" value="Project C"/>
         <column name="description" value="Description for project C"/>
         <column name="rate" value="666"/>
         <column name="person_id" valueComputed="(SELECT id FROM tps_person WHERE email = 'demo@worktajm.com')"/>
      </insert>
   </changeSet>
   
   <!-- Additing more optional attributes for person -->
   <changeSet id="11" author="hirro">
      <addColumn tableName="tps_customer" schemaName="tps">
         <column name="organizationNumber" type="varchar"/>
         <column name="vatRegistrationNumber" type="varchar"/>
         <column name="invoiceNumber" type="int"/>
         <column name="email" type="varchar"/>
         <column name="bank" type="varchar"/>
         <column name="person_id" type="bigint"/>         
      </addColumn>
   </changeSet>   

</databaseChangeLog>
